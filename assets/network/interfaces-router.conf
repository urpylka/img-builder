# interfaces(5) file used by ifup(8) and ifdown(8)

# Include files from /etc/network/interfaces.d:
# source-directory /etc/network/interfaces.d

allow-auto lo
iface lo inet loopback

allow-auto eth0
allow-hotplug eth0
iface eth0 inet dhcp
    post-up \
        route add default gw 10.104.8.1 dev eth0 metric 1000 \
        && echo "#1: Route has been added" \
        || echo "#1: Route has NOT been added"
    post-up \
        systemctl start xl2tpd \
        && echo "#2: xl2tpd has been started" \
        || echo "#2: xl2tpd has NOT been started"
    pre-down \
        systemctl stop xl2tpd \
        && echo "#3: xl2tpd has been stopped" \
        || echo "#3: xl2tpd has NOT been stopped"
    pre-down \
        route del default gw 10.104.8.1 dev eth0 metric 1000 \
        && echo "#4: Route has been deleted" \
        || echo "#4: Route has NOT been deleted"

# Uncomment section below if you wanna use internal Ethernet as WAN port with internet access by DHCP
# iface eth0 inet dhcp
#     post-up sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"
#     post-up iptables -A FORWARD -i br0 -o eth0 -j ACCEPT
#     post-up iptables -A FORWARD -i eth0 -o br0 -j ACCEPT
#     post-up iptables -A POSTROUTING -o eth0 -t nat -j MASQUERADE

allow-hotplug ppp100
iface ppp100 inet manual
    post-up \
        sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward" \
        && echo "#5: Forwarding has been enabled" \
        || echo "#5: Forwarding has NOT been enabled"
    post-up \
        iptables -A FORWARD -i br0 -o ppp100 -j ACCEPT \
        && echo "#6: Forwarding has been enabled" \
        || echo "#6: Forwarding has NOT been enabled"
    post-up \
        iptables -A FORWARD -i ppp100 -o br0 -j ACCEPT \
        && echo "#7: Forwarding has been enabled" \
        || echo "#7: Forwarding has NOT been enabled"
    post-up \
        iptables -A POSTROUTING -o ppp100 -t nat -j MASQUERADE \
        && echo "#8: Masquerading has been enabled" \
        || echo "#8: Masquerading has NOT been enabled"
    post-up \
        route add default dev ppp100 \
        && echo "#9: Route has been added" \
        || echo "#9: Route has NOT been added"
    pre-down \
        route del default dev ppp100 \
        && echo "#10: Route has been deleted" \
        || echo "#10: Route has NOT been deleted"

allow-auto wlan0
allow-hotplug wlan0
iface wlan0 inet manual
    pre-up \
        rfkill unblock wifi \
        && echo "#11: Wi-Fi has been unlocked" \
        || echo "#11: Wi-Fi has NOT been unlocked"
    post-up \
        /usr/sbin/hostapd \
        -P /var/run/hostapd.$IFACE.pid \
        -B /boot/img-builder/hostapd.conf \
        && echo "#12: hostapd has been started" \
        || echo "#12: hostapd has NOT been started"
    # it will raise an error if br0 wont be created
    pre-down \
        cat /var/run/hostapd.$IFACE.pid | xargs kill \
        && echo "#13: hostapd has been stopped" \
        || echo "#13: hostapd has NOT been stopped"

allow-auto br0
iface br0 inet static
    address 192.168.11.1
    netword 192.168.11.0
    netmask 255.255.255.0
    # gateway 192.168.11.1
    broadcast 192.168.11.255
    # bridge_ports wlan0 eth0
    bridge_ports wlan0
    # it field cannot be empty otherwise it will take eth0 (use wlan0 as first arg)
    # wlan0 isn't set because is used bridge=wlan0 in /etc/hostapd/hostapd.conf
    bridge_stp off
    bridge_fd 0
    bridge_maxwait 0
    post-up \
        /usr/sbin/dnsmasq \
        --pid-file=/var/run/dnsmasq.$IFACE.pid \
        --dhcp-leasefile=/var/lib/misc/dnsmasq.$IFACE.leases \
        --conf-file=/dev/null \
        --interface=$IFACE --except-interface=lo,eth1,tun0,eth0 \
        --bind-interfaces \
        --dhcp-range=192.168.11.100,192.168.11.254,24h \
        && echo "#14: dnsmasq has been started" \
        || echo "#14: dnsmasq has NOT been started"
    pre-down \
        cat /var/run/dnsmasq.$IFACE.pid | xargs kill \
        && echo "#15: dnsmasq has been stopped" \
        || echo "#15: dnsmasq has NOT been stopped"

# iface br0 inet dhcp
#     bridge_ports eth0 wlan0
#     pre-up ifconfig eth0 0.0.0.0 up
#     pre-up ifconfig wlan0 0.0.0.0 up
#     pre-up brctl addbr br0
#     pre-up brctl addif br0 eth0
#     post-down ifconfig wlan0 0.0.0.0 down
#     post-down ifconfig eth0 0.0.0.0 down
#     post-down brctl delif br0 eth0
#     post-down brctl delbr br0

allow-hotplug eth1
no-auto-down eth1
iface eth1 inet dhcp
    # /etc/sysctl.conf ipv4.ip_forward=1
    post-up \
        sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward" \
        && echo "#16: Forwarding has been enabled" \
        || echo "#16: Forwarding has NOT been enabled"
    post-up \
        iptables -A FORWARD -i br0 -o eth1 -j ACCEPT \
        && echo "#17: Forwarding has been enabled" \
        || echo "#17: Forwarding has NOT been enabled"
    post-up \
        iptables -A FORWARD -i eth1 -o br0 -j ACCEPT \
        && echo "#18: Forwarding has been enabled" \
        || echo "#18: Forwarding has NOT been enabled"
    post-up \
        iptables -A POSTROUTING -o eth1 -t nat -j MASQUERADE \
        && echo "#19: Masquerading has been enabled" \
        || echo "#19: Masquerading has NOT been enabled"

allow-hotplug tun0
iface tun0 inet manual
    pre-up \
        route del -net 0.0.0.0/1 \
        && echo "#20: Route has been deleted" \
        || echo "#20: Route has NOT been deleted"
    pre-up \
        route del -net 128.0.0.0/1\
        && echo "#21: Route has been deleted" \
        || echo "#21: Route has NOT been deleted"
    pre-up \
        route del -host 255.255.255.0 \
        && echo "#22: Route has been deleted" \
        || echo "#22: Route has NOT been deleted"
